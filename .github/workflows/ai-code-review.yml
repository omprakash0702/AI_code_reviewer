name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:

  # ------------------------------------------------------------
  # JOB 1 â€” Code Review
  # ------------------------------------------------------------
  review:
    runs-on: ubuntu-latest
    steps:

      # Checkout PR code
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Python Dependencies
        run: |
          pip install flake8 pylint bandit black httpx

      # Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install JS Tools
        run: |
          npm install -g eslint prettier jq

      # Get changed files
      - name: Get Changed Files
        id: changed_files
        run: |
          FILES=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files --jq '.[].filename')
          echo "files=$FILES" >> $GITHUB_OUTPUT

      # Review each file
      - name: Review Changed Files
        id: review_files
        run: |
          FILES="${{ steps.changed_files.outputs.files }}"

          echo "Changed files:"
          echo "$FILES"

          > all_patches.diff

          for file in $FILES; do

            if [[ "$file" != *.py && "$file" != *.js ]]; then
              echo "Skipping non-code file: $file"
              continue
            fi

            # Run analyzer
python - <<EOF > analysis.json
import json, subprocess

file = "${file}"

def run(cmd):
    result = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    return result.stdout.strip()

analysis = {
    "lint_issues": run(["flake8", file]).splitlines(),
    "logic_issues": run(["pylint", file, "-rn", "-sn"]).splitlines(),
    "security_issues": run(["bandit", "-q", file]).splitlines(),
    "format_suggestions": run(["black", "--diff", file])
}
print(json.dumps(analysis))
EOF

            CODE_CONTENT=$(cat "$file" | sed 's/"/\\"/g')

            RESPONSE=$(curl -s -X POST \
              -H "Content-Type: application/json" \
              -d "{\"filename\": \"$file\", \"code\": \"$CODE_CONTENT\", \"analysis\": $(cat analysis.json)}" \
              https://YOUR_API_URL/review)

            echo "$RESPONSE" > result.json

            PATCH=$(cat result.json | jq -r '.patch')

            echo "$PATCH" >> all_patches.diff
          done

      # Comment PR
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('result.json', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "### ðŸ¤– AI Code Review Result\n```\n" + summary + "\n```"
            })


  # ------------------------------------------------------------
  # JOB 2 â€” Auto Fix Branch + PR
  # ------------------------------------------------------------
  auto_fix:
    needs: review
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.fork == false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Apply Patch
        run: |
          if [ ! -s all_patches.diff ]; then
            echo "No patches found."
            exit 0
          fi

          git checkout -b ai-auto-fix-${{ github.run_id }}
          git apply all_patches.diff || (echo "Patch failed"; exit 1)
          git add .
          git commit -m "ðŸ¤– AI Auto Fix"

      - name: Push Fix Branch
        run: |
          git push origin ai-auto-fix-${{ github.run_id }}

      - name: Create Auto Fix PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "ðŸ¤– AI Auto Fix",
              head: `ai-auto-fix-${{ github.run_id }}`,
              base: context.payload.pull_request.base.ref,
              body: "Automated fix generated by AI Code Reviewer."
            })



